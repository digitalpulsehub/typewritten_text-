class TypewrittenText {
    constructor() {
        this.editor = document.getElementById('editor');
        this.titleInput = document.getElementById('titleInput');
        this.passwordInput = document.getElementById('passwordInput');
        this.accessPassword = document.getElementById('accessPassword');
        this.showPassword = document.getElementById('showPassword');
        this.shareBtn = document.getElementById('shareBtn');
        this.clearBtn = document.getElementById('clearBtn');
        this.linkContainer = document.getElementById('linkContainer');
        this.generatedLink = document.getElementById('generatedLink');
        this.copyBtn = document.getElementById('copyBtn');
        this.passwordPrompt = document.getElementById('passwordPrompt');
        this.submitPassword = document.getElementById('submitPassword');
        this.cancelPassword = document.getElementById('cancelPassword');
        this.passwordError = document.getElementById('passwordError');
        this.passwordStatus = document.getElementById('passwordStatus');
        this.charCount = document.getElementById('charCount');
        this.wordCount = document.getElementById('wordCount');
        this.viewCount = document.getElementById('viewCount');
        this.toast = document.getElementById('toast');
        
        this.currentDocumentId = null;
        this.autoSaveInterval = 3000;
        this.storageKey = 'typewritten_draft';
        
        this.init();
    }
    
    init() {
        this.setupEventListeners();
        this.loadFromStorage();
        this.checkUrlHash();
        this.startAutoSave();
        this.updateCounters();
    }
    
    setupEventListeners() {
        // Editor events
        this.editor.addEventListener('input', () => {
            this.updateCounters();
            this.updateShareButton();
            this.saveToStorage();
        });
        
        this.titleInput.addEventListener('input', () => {
            this.updateShareButton();
            this.saveToStorage();
        });
        
        // Password toggle
        this.showPassword.addEventListener('change', (e) => {
            this.passwordInput.type = e.target.checked ? 'text' : 'password';
        });
        
        // Toolbar
        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const command = e.target.dataset.command;
                document.execCommand(command, false, null);
                this.editor.focus();
            });
        });
        
        // Buttons
        this.shareBtn.addEventListener('click', () => this.generateLink());
        this.clearBtn.addEventListener('click', () => this.clearDocument());
        this.copyBtn.addEventListener('click', () => this.copyLink());
        this.submitPassword.addEventListener('click', () => this.checkPassword());
        this.cancelPassword.addEventListener('click', () => this.closePasswordPrompt());
        
        // Password prompt enter key
        this.accessPassword.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.checkPassword();
        });
        
        // Prevent paste with formatting
        this.editor.addEventListener('paste', (e) => {
            e.preventDefault();
            const text = e.clipboardData.getData('text/plain');
            document.execCommand('insertText', false, text);
        });
    }
    
    updateCounters() {
        const text = this.editor.textContent;
        const words = text.trim() ? text.trim().split(/\s+/).length : 0;
        const chars = text.length;
        
        this.charCount.textContent = `${chars} character${chars !== 1 ? 's' : ''}`;
        this.wordCount.textContent = `${words} word${words !== 1 ? 's' : ''}`;
    }
    
    updateViews(documentId) {
        if (!documentId) return;
        
        const data = localStorage.getItem(`post_${documentId}`);
        if (data) {
            try {
                const parsed = JSON.parse(data);
                parsed.views = (parsed.views || 0) + 1;
                localStorage.setItem(`post_${documentId}`, JSON.stringify(parsed));
                
                // Update view counter if viewing this document
                if (this.currentDocumentId === documentId) {
                    this.viewCount.textContent = `${parsed.views} view${parsed.views !== 1 ? 's' : ''}`;
                    this.viewCount.classList.remove('hidden');
                }
            } catch (e) {
                console.error('Error updating views:', e);
            }
        }
    }
    
    saveToStorage() {
        const data = {
            title: this.titleInput.value,
            content: this.editor.innerHTML,
            timestamp: Date.now()
        };
        localStorage.setItem(this.storageKey, JSON.stringify(data));
    }
    
    loadFromStorage() {
        const saved = localStorage.getItem(this.storageKey);
        if (saved) {
            try {
                const data = JSON.parse(saved);
                this.titleInput.value = data.title || '';
                this.editor.innerHTML = data.content || '';
                this.showToast('Draft loaded from local storage');
            } catch (e) {
                console.error('Error loading draft:', e);
            }
        }
    }
    
    startAutoSave() {
        setInterval(() => {
            this.saveToStorage();
        }, this.autoSaveInterval);
    }
    
    updateShareButton() {
        const hasContent = this.editor.textContent.trim().length > 0;
        this.shareBtn.disabled = !hasContent;
    }
    
    generateLink() {
        const title = this.titleInput.value.trim();
        const content = this.editor.innerHTML;
        const password = this.passwordInput.value.trim();
        
        // Generate unique ID
        const id = this.generateId();
        
        // Prepare data
        const data = {
            title: title,
            content: content,
            timestamp: Date.now(),
            password: password || null,
            views: 0,
            protected: !!password
        };
        
        // Store document
        localStorage.setItem(`post_${id}`, JSON.stringify(data));
        
        // Build URL
        const baseUrl = window.location.origin + window.location.pathname;
        const url = `${baseUrl}#${id}`;
        
        // Show link
        this.generatedLink.value = url;
        this.passwordStatus.textContent = password ? 'Yes' : 'No';
        this.linkContainer.classList.remove('hidden');
        
        // Clear password field for next use
        this.passwordInput.value = '';
        
        // Scroll to link
        this.linkContainer.scrollIntoView({ behavior: 'smooth' });
        
        this.showToast('Shareable link created!');
    }
    
    generateId() {
        return Math.random().toString(36).substring(2) + Date.now().toString(36);
    }
    
    checkUrlHash() {
        const hash = window.location.hash.substring(1);
        if (hash && hash.length > 10) {
            this.currentDocumentId = hash;
            this.loadDocument(hash);
        }
    }
    
    loadDocument(id) {
        const data = localStorage.getItem(`post_${id}`);
        if (!data) {
            this.showToast('Document not found', true);
            return;
        }
        
        try {
            const parsed = JSON.parse(data);
            
            // Check if password protected
            if (parsed.password) {
                this.showPasswordPrompt();
                return;
            }
            
            // Load content
            this.titleInput.value = parsed.title || '';
            this.editor.innerHTML = parsed.content || '';
            this.updateCounters();
            this.updateViews(id);
            this.showToast('Document loaded from link');
            
            // Disable editing when viewing shared document
            this.editor.setAttribute('contenteditable', 'false');
            this.titleInput.disabled = true;
            this.shareBtn.disabled = true;
            
        } catch (e) {
            console.error('Error loading document:', e);
            this.showToast('Error loading document', true);
        }
    }
    
    showPasswordPrompt() {
        this.passwordPrompt.classList.remove('hidden');
        this.accessPassword.focus();
    }
    
    closePasswordPrompt() {
        this.passwordPrompt.classList.add('hidden');
        this.accessPassword.value = '';
        this.passwordError.textContent = '';
    }
    
    checkPassword() {
        const password = this.accessPassword.value.trim();
        const data = localStorage.getItem(`post_${this.currentDocumentId}`);
        
        if (!data) {
            this.passwordError.textContent = 'Document not found';
            return;
        }
        
        try {
            const parsed = JSON.parse(data);
            
            if (parsed.password === password) {
                // Password correct
                this.titleInput.value = parsed.title || '';
                this.editor.innerHTML = parsed.content || '';
                this.updateCounters();
                this.updateViews(this.currentDocumentId);
                this.closePasswordPrompt();
                
                // Disable editing
                this.editor.setAttribute('contenteditable', 'false');
                this.titleInput.disabled = true;
                this.shareBtn.disabled = true;
                
                this.showToast('Password accepted - Document loaded');
            } else {
                this.passwordError.textContent = 'Incorrect password. Please try again.';
                this.accessPassword.value = '';
                this.accessPassword.focus();
            }
        } catch (e) {
            this.passwordError.textContent = 'Error accessing document';
        }
    }
    
    copyLink() {
        this.generatedLink.select();
        this.generatedLink.setSelectionRange(0, 99999);
        
        try {
            navigator.clipboard.writeText(this.generatedLink.value);
            this.showToast('Link copied to clipboard!');
        } catch (err) {
            document.execCommand('copy');
            this.showToast('Link copied!');
        }
    }
    
    clearDocument() {
        if (confirm('Are you sure you want to clear the current document? This cannot be undone.')) {
            this.titleInput.value = '';
            this.editor.innerHTML = '';
            this.passwordInput.value = '';
            this.linkContainer.classList.add('hidden');
            localStorage.removeItem(this.storageKey);
            this.updateCounters();
            this.updateShareButton();
            
            // Re-enable editing if it was disabled
            this.editor.setAttribute('contenteditable', 'true');
            this.titleInput.disabled = false;
            this.shareBtn.disabled = false;
            
            // Clear URL hash
            window.location.hash = '';
            this.currentDocumentId = null;
            this.viewCount.classList.add('hidden');
            
            this.showToast('Document cleared');
        }
    }
    
    showToast(message, isError = false) {
        this.toast.textContent = message;
        this.toast.style.background = isError ? '#d32f2f' : '#000';
        this.toast.classList.add('show');
        
        setTimeout(() => {
            this.toast.classList.remove('show');
        }, 3000);
    }
}

// Initialize the app
document.addEventListener('DOMContentLoaded', () => {
    new TypewrittenText();
});
